---
title: "Problem Set 3"
output: pdf_document
date: "2023-08-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
meta_data <- read.csv(file = "QBS103_finalProject_metadata.csv")
# Part 1 first convert lists to vectors
age <- unlist(meta_data["age"], use.names = FALSE)
ferritin <- unlist(meta_data["ferritin.ng.ml."], use.names = FALSE)
procalcitonin <- unlist(meta_data["procalcitonin.ng.ml.."], use.names = FALSE)
lactate <- unlist(meta_data["lactate.mmol.l."], use.names = FALSE)
# function that calculates the sum of a vector
sum_function <- function(vector_input) {
  # Create a variable to store the output
  sum_total = 0
  # Convert the input vector to numeric if needed
  int_vector_input = suppressWarnings(as.numeric(vector_input))
  # Loops through the vector inputted into the function
  for (i in int_vector_input) {
    # Checks for any invalid data
    if (!is.na(i)) {
      sum_total = i + sum_total
    }
  }
  return (sum_total)
}

# Test function sum_function and sum by age
print("Part 1: Sum")
sum_function(age)
sum(suppressWarnings(as.numeric(age)), na.rm = TRUE)
# Use apply to test the functions sum and sum_function
# Need to make new data frames because apply function does not take in vectors
test4values <- c("age", "ferritin.ng.ml.", "procalcitonin.ng.ml..", "lactate.mmol.l.")
test_data2 <- meta_data[test4values]
# Make the values numerical
test_data2$age = suppressWarnings(as.numeric(as.character(test_data2$age)))
test_data2$ferritin.ng.ml. = suppressWarnings(as.numeric(as.character(test_data2$ferritin.ng.ml.)))
test_data2$procalcitonin.ng.ml.. = suppressWarnings(as.numeric(as.character(test_data2$procalcitonin.ng.ml..)))
test_data2$lactate.mmol.l. = suppressWarnings(as.numeric(as.character(test_data2$lactate.mmol.l.)))
# Use apply to test both functions
print(apply(test_data2, 2, sum_function))
print(apply(test_data2, 2, sum, na.rm = TRUE))
# Part 2 function to calculate the mean of vectors
mean_function <- function(vector_input) {
  sum_total = sum_function(vector_input)
  count = 0
  int_vector_input = suppressWarnings(as.numeric(vector_input))
  for (i in int_vector_input) {
    # Checks for any invalid data
    if (!is.na(i)) {
      count = count + 1
    }
  }
  return(round(sum_total/count,2))
}

# Test function mean_function and mean by age
print("Part 2: Mean")
mean_function(age)
round(mean(suppressWarnings(as.numeric(age)), na.rm = TRUE),2)
# Use apply to test both mean functions
print(apply(test_data2, 2, mean_function))
print(round(apply(test_data2, 2, mean, na.rm = TRUE),2))


# Part 3
library(ggplot2)

# Calculate the standard deviation to be plotted later
sd_deviation = round(apply(test_data2, 2, sd, na.rm = TRUE),2)
# Make a function to loop through the 3 y axis
plot_graphs <- function() {
  for (i in 2:length(test_data2[1,])) {
    names = colnames(test_data2[i])
    if (names == "ferritin.ng.ml.") {
      names_input = "ferritin (ng/mL)"
      name_name = "Ferritin"
    }
    else if (names == "procalcitonin.ng.ml..") {
      names_input = "procalcitonin (ng/mL)"
      name_name = "Procalcitonin"
    }
    else {
      names_input = "lactate (mmol/l)"
      name_name = "Lactate"
    }
    # Remove NAs for ferritin and age
    scatter <- ggplot(test_data2[which(!is.na(test_data2[[names]])&(test_data2$age)),], aes(x = age, y = .data[[names]])) +
      geom_point(color = "red") +
      labs(
        title = substitute(paste(bolditalic(name_name), " vs Continuous Covariat (Age)")),
        subtitle = paste("Mean:", mean_function(test_data2[[names]]), " Standard Deviation:", sd_deviation[names]),
        x = expression(bold("Age")),
        y = substitute(paste(bolditalic(names_input),""))
      ) +
      theme(plot.title = element_text(size = 18, color = "darkgreen", hjust = 1/2),
            plot.subtitle = element_text(color = "red", hjust = 1/2),
            panel.background = element_rect(fill = 'lightblue', color = 'black'),
            panel.grid.major = element_line(color = 'black', linetype = 'dotted')) +
      scale_x_continuous(limits = c(15, 100)) +
      geom_hline(yintercept = mean_function(test_data2[[names]]), color = "orange", size = 2) +
      geom_hline(yintercept = mean_function(test_data2[[names]]) + sd_deviation[names], 
                 linetype = "dashed", color = "purple", size = 1) +
      geom_hline(yintercept = mean_function(test_data2[[names]]) - sd_deviation[names], 
                 linetype = "dashed", color = "purple", size = 1) 
    print(scatter)
  }
}
plot_graphs()
```

